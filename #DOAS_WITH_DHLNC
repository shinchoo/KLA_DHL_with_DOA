USE SANDBOX.OPS;

SELECT
"LPN Number"
,"PRID"
, COUNT("LPN Number","PRID") CA
, MAX(CASE "Product Class" WHEN 'DOA' THEN 1 ELSE 0 END) AS MX //Pay attention to the technique
, MAX(CASE "Product Class" WHEN 'GOOD' THEN 1 ELSE 0 END) AS MX2
, MAX(CASE "Product Class" WHEN 'DEFECTIVE' THEN 1 ELSE 0 END) AS MX3
, MAX(CASE "Product Class" WHEN 'FA' THEN 1 ELSE 0 END) AS MX4
FROM
(
SELECT *
FROM (
  
SELECT "LPN Number"
,"Product Class"
,"PRID"
,COUNT("LPN Number","Product Class","PRID")
FROM DHL_LPN_HISTORY_WIP
GROUP BY "LPN Number","Product Class","PRID"
--THIS IS JUST TO SUM INTO ONE PRID/PRODUCT CLASS
)
LEFT JOIN GEAR.INSIGHTS.MFG_DOA_WITH_NC AS NC ON "PRID" = NC."PRTNUMBER"
WHERE NC."PRTNUMBER" IS NOT NULL
--AND "Product Class" = 'GOOD'
ORDER BY "LPN Number", "Product Class"
--JOINED WITH NC BY CONNECTING PRID AND PRTNUMBER AS LONG AS THE DATA EXISTS IN THE NC, AND SORTED OUT MISSING PRID NUMBER IN DHL, BUT SEEMS LIKE AT LEAST EVERY DOA HAS ONE PRID
  )
  GROUP BY "LPN Number", "PRID"
  HAVING "MX" = 0
--  AND "MX2" = 1
--  AND "MX3" = 0
--  AND "MX4" = 0
  --HAVING "Product Class" = 'DOA'
  ORDER BY "LPN Number"
